{% load item_tags %}
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    {% if item %}
    <title>Deme &raquo; {% viewable_name item %}{% if action_title %} &raquo; {{ action_title }}{% endif %}{% if specific_version %} &raquo; v{{ item.version_number }}{% endif %}</title>
    {% else %}
    <title>Deme{% if action_title %} &raquo; {{ action_title }}{% endif %}</title>
    {% endif %}

    
    <link rel="shortcut icon" href="{% block favicon %}{% if item %}{{ item.actual_item_type|icon_url:24 }}{% else %}{{ accepted_item_type|icon_url:24 }}{% endif %}{% endblock favicon %}" type="image/x-icon" />
    <!--<link rel="shortcut icon" href="{% media_url "favicon.ico" %}" type="image/x-icon" />-->

    {% universal_edit_button %}

    <link rel="stylesheet" href="{% media_url "stylesheets/blueprint/screen.css" %}" type="text/css" media="screen, projection" />
    <link rel="stylesheet" href="{% media_url "stylesheets/blueprint/print.css" %}" type="text/css" media="print" />
    <!--[if IE]>
        <link rel="stylesheet" href="{% media_url "stylesheets/blueprint/ie.css" %}" type="text/css" media="screen, projection" />
    <![endif]-->
    <link href="{% media_url "stylesheets/base.css" %}" media="all" rel="Stylesheet" type="text/css" />

    <script type="text/javascript" src="{% media_url "javascripts/jquery-1.3.2.min.js" %}"></script>
    <script type="text/javascript" src="{% media_url "javascripts/jquery-ui-1.7.1.custom.min.js" %}"></script>
    <!--<script type="text/javascript" src="{% media_url "javascripts/jquery-ui-layout-1.2.0.min.js" %}"></script>-->
    <link href="{% media_url "stylesheets/smoothness/jquery-ui-1.7.1.custom.css" %}" media="all" rel="Stylesheet" type="text/css" />

    {% ifequal action 'show' %}
    {% if item %}
    <link rel="alternate" type="application/rss+xml" title="Action notice feed" href="{% url item_url viewer=viewer_name,action="show",noun=item.pk,format="rss" %}" />
    {% endif %}
    {% endifequal %}
    {% ifequal action 'list' %}
    <link rel="alternate" type="application/rss+xml" title="Item feed" href="{% url item_type_url viewer=viewer_name,action="list",format="rss" %}" />
    {% endifequal %}
    <script type="text/javascript">
        // from http://www.filamentgroup.com/examples/buttonFrameworkCSS/
        $(function(){
            //all hover and click logic for buttons
            $(".fg-button:not(.ui-state-disabled)")
            .hover(
                function(){ 
                    $(this).addClass("ui-state-hover"); 
                },
                function(){ 
                    $(this).removeClass("ui-state-hover"); 
                }
            )
            .mousedown(function(){
                    $(this).parents('.fg-buttonset-single:first').find(".fg-button.ui-state-active").removeClass("ui-state-active");
                    if( $(this).is('.ui-state-active.fg-button-toggleable, .fg-buttonset-multi .ui-state-active') ){ $(this).removeClass("ui-state-active"); }
                    else { $(this).addClass("ui-state-active"); }	
            })
            .mouseup(function(){
                if(! $(this).is('.fg-button-toggleable, .fg-buttonset-single .fg-button,  .fg-buttonset-multi .fg-button') ){
                    $(this).removeClass("ui-state-active");
                }
            });
        });

        // To give the gray "Search" text in the search box
        $(document).ready(function () {
            var search_box_changed = {% if search_query %}true{% else %}false{% endif %};
            var search_box = document.getElementById('search_box');
            search_box.onfocus = function(e){
                if (!search_box_changed) {
                    search_box_changed = true;
                    search_box.value = '';
                    search_box.style.color = 'inherit';
                }
            };
            search_box.onblur = function(e){
                if (search_box.value == '') {
                    search_box_changed = false;
                    search_box.value = 'Search';
                    search_box.style.color = '#777';
                }
            };
            search_box.onblur();
        });

        $(document).ready(function () {
            $("#right_accordion").accordion({
                fillSpace: false,
                autoHeight: false,
            });
        });
    </script>        

    <script type="text/javascript" src="{% media_url "javascripts/sha1.js" %}"></script>
    <script type="text/javascript" src="{% media_url "javascripts/mysql_pre41_password.js" %}"></script>

    <script type="text/javascript">

        function get_encrypted_password(raw_password, algo, salt, nonce) {
            var original_hashed_password;
            if (algo == 'sha1') {
                original_hashed_password = SHA1(salt + raw_password);
            } else if (algo == 'mysql_pre41_password') {
                original_hashed_password = mysql_pre41_password(raw_password);
            } else {
                return 'unknown algo: ' + algo;
            }
            return SHA1(nonce + original_hashed_password);
        }

        function encrypt_password() {
            var raw_password = document.forms['password_form']['password'].value;
            var url = '{% url item_type_url viewer="demeaccount",action="getencryptionmethod" %}';
            jQuery.getJSON(url, {username:document.forms['password_form']['username'].value}, function(json) {
                var algo = json.algo;
                var salt = json.salt;
                var nonce = json.nonce;
                var encrypted_password = get_encrypted_password(raw_password, algo, salt, nonce);
                document.forms['real_password_form']['hashed_password'].value = encrypted_password;
                document.forms['real_password_form']['username'].value = document.forms['password_form']['username'].value;
                document.forms['real_password_form'].submit();
            });
        }
    </script>
    
</head>

<body>

<div class="site_outer">
<div class="site_inner">

<div class="header" style="padding-top: 3px; padding-bottom: 3px;">

    <table style="margin-bottom: 0;">
        <tr>

            <td style="vertical-align: top; width: 200px; padding: 0;" rowspan="2">
                <div class="top_left">
                    <a href="/"><img src="{% media_url "spacer.gif" %}" alt="Deme Logo" style="height: 100px; width: 200px; border: 1px solid #aaa; background-color: #00c; -moz-border-radius: 8px; -webkit-border-radius: 8px;" /></a>
                </div>

            </td>

            <td style="vertical-align: top; text-align: center; padding: 0; padding-left: 5px; padding-right: 5px;">
                <a href="{% url item_type_url viewer="item" %}" class="fg-button ui-state-default fg-button-icon-right ui-corner-all">Items<span class="ui-icon ui-icon-triangle-1-s"></span></a>
                <form method="get" action="{% url item_type_url viewer="item" %}" style="display: inline;">
                    <input type="search" id="search_box" name="q" value="{{ search_query }}" style="width: 20em;" />
                    {# TODO add magnifying glass #}
                </form>
            </td>

            <td style="vertical-align: top; text-align: right; padding: 0;">
                <div style="float: right;">
                {% ifequal cur_agent.item_type_string 'AnonymousAgent' %}
                <div style="display: none;" id="login_dialog_password" title="Login">
                    <form name="password_form" onsubmit="$('#login_dialog_password').dialog('hide'); encrypt_password(); return false;">
                        <div>Username:</div>
                        <div><input type="text" name="username" /></div>
                        <div>Password:</div>
                        <div><input type="password" name="password" /></div>
                    </form>
                    <form name="real_password_form" action="{% url item_type_url viewer="demeaccount",action="login" %}?redirect={{ full_path|urlencode }}" method="post">
                        <input type="hidden" name="username" />
                        <input type="hidden" name="hashed_password" onchange="document.forms['password_form']['hashed_password'].value = '';" />
                    </form>
                </div>
                <div style="display: none;" id="login_dialog_openid" title="Login">
                    <form name="openid_form" action="{% url item_type_url viewer="openidaccount",action="login" %}?redirect={{ full_path|urlencode }}" method="post" onsubmit="$('#login_dialog_openid').dialog('hide');">
                        <label>OpenID URL: <input type="text" name="openid_url" /></label>
                    </form>
                </div>
                <div style="z-index: 100000; position: relative;" id="login_dropdown_outer">
                    <div>
                        <div style="text-align: left; border: 1px solid #aaa; position: absolute; padding: 3px; background: #fff; display: none;" id="login_dropdown_items">
                            <div><a href="#" onclick="$('#login_dialog_password').dialog('open'); return false;">Deme account</a></div>
                            <div><a href="#" onclick="$('#login_dialog_openid').dialog('open'); return false;">OpenID</a></div>
                            <div><a href="{% url item_type_url viewer="webauth",action="login" %}?redirect={{ full_path|urlencode }}">Webauth</a></div>
                            <div><a href="{% url item_type_url viewer="authenticationmethod",action="login" %}?redirect={{ full_path|urlencode }}">Login as</a></div>
                        </div>
                    </div>
                    <a id="login_dropdown_link" href="#" onclick="return false;" class="fg-button ui-state-default fg-button-icon-right ui-corner-all">Login<span class="ui-icon ui-icon-triangle-1-s"></span></a>
                    <script type="text/javascript">
                        $(document).ready(function () {
                            $('#login_dropdown_outer').hover(function(){$('#login_dropdown_items').css('margin-top', $('#login_dropdown_link').outerHeight()).css('min-width', $('#login_dropdown_link').outerWidth()).show()}, function(){$('#login_dropdown_items').hide()});
                            $('#login_dialog_password').dialog({
                                autoOpen: false,
                                buttons: {"Login": function(){$(this).dialog('close'); document.forms['password_form'].onsubmit()}, "Cancel": function(){$(this).dialog("close")} },
                                modal: true,
                                bgiframe: true,
                            });
                            $('#login_dialog_openid').dialog({
                                autoOpen: false,
                                buttons: {"Login": function(){$(this).dialog('close'); document.forms['openid_form'].submit()}, "Cancel": function(){$(this).dialog("close")} },
                                modal: true,
                                bgiframe: true,
                            });
                        });
                    </script>
                </div>
                {% else %}
                <form name="logout_form" style="display: inline;" method="post" action="{% url item_type_url viewer="authenticationmethod",action="logout" %}?redirect={{ full_path|urlencode }}">
                </form>
                <div style="z-index: 100000; position: relative;" id="logout_dropdown_outer">
                    <div>
                        <div style="text-align: left; border: 1px solid #aaa; position: absolute; padding: 3px; background: #fff; display: none;" id="logout_dropdown_items">
                            <div><a href="{{ cur_agent.get_absolute_url }}">My account</a></div>
                            <div><a href="#" onclick="document.forms['logout_form'].submit(); return false;">Logout</a></div>
                            <div><a href="{% url item_type_url viewer="authenticationmethod",action="login" %}?redirect={{ full_path|urlencode }}">Login as</a></div>
                        </div>
                    </div>
                    <a id="logout_dropdown_link" href="#" onclick="return false;" class="fg-button ui-state-default fg-button-icon-right ui-corner-all">Logged in as {% viewable_name cur_agent %}<span class="ui-icon ui-icon-triangle-1-s"></span></a>
                    <script type="text/javascript">
                        $(document).ready(function () {
                            $('#logout_dropdown_outer').hover(function(){$('#logout_dropdown_items').css('margin-top', $('#logout_dropdown_link').outerHeight()).css('min-width', $('#logout_dropdown_link').outerWidth()).show()}, function(){$('#logout_dropdown_items').hide()});
                        });
                    </script>
                </div>
                {% endifequal %}
                </div>
                <div style="clear: both;">
                </div>
            </td>

        </tr>
        <tr>
            <td style="vertical-align: bottom; padding: 0; padding-left: 5px;" colspan="2">
                <div style="clear: both;"></div>
                {% if item %}
                <div style="float: right;">
                    {% itemtoolbar %}
                </div>
                {% endif %}

                <div class="title">
                {% block title %}
                {% if item %}
                <a href="{% url item_url viewer=viewer_name,action="show",noun=item.pk %}" class="img_link"><img src="{{ item.actual_item_type|icon_url:24 }}" /> <span>{% viewable_name item %}</span></a>{% if action_title %} &raquo; {{ action_title }}{% endif %}{% if specific_version %} &raquo; v{{ item.version_number }}{% endif %}
                {% else %}
                <img src="{{ accepted_item_type|icon_url:24 }}" />{% if action_title %} {{ action_title }}{% endif %}
                {% endif %}
                {% endblock title %}
                </div>
            </td>
        </tr>
    </table>

</div>

<script type="text/javascript">
    //TODO figure out padding
    function hide_column_right() {
        $('#right_table_column').hide();
        $('#right_table_column_hidden').show();
        $('#right_table_column_hidden').width($('#right_table_column_hidden a').width());
        $('#center_table_column').width(960 - $('#right_table_column_hidden').width() - $('#left_table_column_hidden').width());
    }
    function show_column_right() {
        $('#right_table_column').show();
        $('#right_table_column_hidden').hide();
        $('#center_table_column').width(960 - $('#right_table_column').width() - $('#left_table_column').width());
    }
</script>

<div class="content_box">
    {% if layout_permissions_problem %}
    <div style="color: #a00; padding: 15px; margin: 15px; border: thin dotted #a00; text-align: center;">
        Permissions Error: You are not authorized to view the layout, so this page is being displayed in the default layout.
    </div>
    {% endif %}

    <table cellspacing="0">
        <tr>
            <td style="vertical-align: top; width: 120px; padding:0;" id="left_table_column">
                <div class="ui-widget-header ui-corner-top ui-helper-clearfix" style="padding: 5px;">
                    Navigation
                </div>
                <div class="ui-widget-content ui-corner-bottom ui-helper-clearfix" style="padding: 5px;">
                    <ul style="list-style-type: none; margin: 0; padding: 0;">
                        <li{% ifequal full_path "/"%} style="font-weight: bold;"{% endifequal %}><a href="/">Home</a></li>
                        <li{% ifequal action "list" %}{% ifequal viewer_name "item" %} style="font-weight: bold;"{% endifequal %}{% endifequal %}><a href="{% url item_type_url viewer="item" %}">Items</a></li>
                        <li{% ifequal viewer_name "codegraph"%} style="font-weight: bold;"{% endifequal %}><a href="{% url item_type_url viewer="codegraph" %}">Codegraph</a></li>
                        <li><a href="http://deme.stanford.edu/static/docs/index.html">Docs</a></li>
                    </ul>
                </div>
            </td>
            <td style="vertical-align: top; width: 600px; padding:0;" id="center_table_column">
                <div style="padding: 0 5px 0 5px;">
                    {% block content %}
                    {% endblock %}
                </div>
            </td>
            <td style="vertical-align: top; display: none; padding:0;" id="right_table_column_hidden">
                <div class="ui-helper-clearfix" style="font-size: 60%;">
                    <a href="#" onclick="show_column_right(); return false;" class="fg-button ui-state-default fg-button-icon-solo ui-corner-all" title="Show"><span class="ui-icon ui-icon-arrowthickstop-1-w"></span> Show</a>
                </div>
            </td>
            <td style="vertical-align: top; width: 240px; padding:0;" id="right_table_column">
                <div class="ui-helper-clearfix" style="font-size: 60%;">
                    <a href="#" onclick="hide_column_right(); return false;" class="fg-button ui-state-default fg-button-icon-solo ui-corner-all" title="Hide"><span class="ui-icon ui-icon-arrowthickstop-1-e"></span> Hide</a>
                </div>

                {# TODO links are black because of ui-widget-content to a #}
                <div id="right_accordion">
                    {% if item %}

                    <h3><a href="#">Item details</a></h3>
                    <div>
                        {% itemdetails %}
                    </div>

                    {% calculatecomments %}
                    <h3><a href="#">{{ n_comments }} comment{{ n_comments|pluralize }}</a></h3>
                    <div>
                        <div><a href="#" onclick="$('.comment_body, .comment_description').toggle(); return false;">Collapse/Expand</a></div>
                        {{ comment_box }}
                    </div>

                    {% calculateactionnotices %}
                    <h3><a href="#">{{ n_action_notices }} action notice{{ n_action_notices|pluralize }}</a></h3>
                    <div>
                        {{ action_notice_box }}
                    </div>

                    {% calculatehistory %}
                    <h3><a href="#">{{ n_versions }} version{{ n_versions|pluralize }}</a></h3>
                    <div>
                        {{ history_box }}
                    </div>

                    {% calculaterelationships %}
                    <h3><a href="#">{{ n_relationships }} related item{{ n_relationships|pluralize }}</a></h3>
                    <div>
                        {{ relationships_box }}
                    </div>

                    <h3><a href="#">Permissions</a></h3>
                    <div>
                        {% permissions_box %}
                    </div>

                    {% else %}

                    <h3><a href="#"></a></h3>
                    <div>
                    </div>

                    {% endif %}
                </div>
            </td>
        </tr>
    </table>

</div>

<div class="footer">
    <p>Copyright &copy;2008-{% now "Y" %} to Deme | <a href="http://github.com/mikemintz/deme/tree/master">Source Code</a> <span class="pipe">|</span> <a href="http://www.stanford.edu/~davies/">Authors</a> | <a href="{% url item_type_url viewer="item",action="admin" %}">Admin</a> | <a href="{% url item_type_url viewer="item",action="recentchanges" %}">Recent Changes</a></p>
    <p>Desktop browser | <a href="list.mobi">Mobile</a> | <a href="list.rss">RSS</a></p> {# TODO generate formats list #}
</div>

</div>
</div>

</body>

</html>

