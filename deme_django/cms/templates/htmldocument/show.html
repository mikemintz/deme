{% extends layout %}
{% load resource_extras %}
{% block favicon %}{{ item.item_type|icon_url:16 }}{% endblock %}
{% block title %}<img src="{{ item.item_type|icon_url:48 }}" /> {% ifagentcan 'view' 'name' item %}{{ item.name }}{% else %}[PERMISSION DENIED]{% endifagentcan %}{% endblock %}
{% block content %}

<script src="http://ajax.googleapis.com/ajax/libs/prototype/1.6.0.2/prototype.js"></script>
<!--
<script type="text/javascript" src="/static/javascripts/prototype.js"></script>
<script type="text/javascript" src="/static/javascripts/class_improved.js"></script>
<script type="text/javascript" src="/static/javascripts/ref.js"></script>
<script type="text/javascript" src="/static/javascripts/ref_deme.js"></script>
-->

{% itemheader %}

<script type="text/javascript">
    var body_str = "{{ itemversion.body|escapejs }}";
    function getBodyIndex() {
        if (Prototype.Browser.IE) {
            var range = window.document.selection.createRange();
            var getOwnerDoc = function(hint) {
                if (!hint) return document; // lame!
                if (/document$/i.test(hint.nodeName))
                    return hint; // hint *is* a document object
                else if (hint.ownerDocument)
                    return hint.ownerDocument;
                else // rare case: eventually hit the document root
                    return getOwnerDoc(hint.parentNode);
            };
            
            range.collapse(true);
            var node = range.parentElement();
            /*
            range.move('Character', 1);
            range.move('Character', -1);
            var id = (Math.random() + '').split('.')[1];
            var span_html_text = '<SPAN id=' + id + '></SPAN>'; //TODO why does it have to be uppercase and no quotes in ie?
            range.pasteHTML(span_html_text);

            var docbody_clone = $($('docbody').cloneNode(true));
            docbody_clone.select('.commentref').each(Element.remove);
            var offset = docbody_clone.innerHTML.indexOf(span_html_text);

            var span = getOwnerDoc(range.parentElement()).getElementById(id);
            span.parentNode.removeChild(span);

            return offset;
            */
        } else {
            var selection = window.getSelection();
            var node = selection.anchorNode;
        }
        if (!node) return null;
        var offset = selection.anchorOffset;

        var id = (Math.random() + '').split('.')[1];
        var span_html_text = '<span id="' + id + '"></span>'; //TODO kind of sketchy to be searching for this exact syntax
        var span = document.createElement('span');
        span.id = id;
        node.parentNode.insertBefore(span, node);

        var docbody_clone = $($('docbody').cloneNode(true));
        docbody_clone.select('.commentref').each(Element.remove);

        var node_index = docbody_clone.innerHTML.indexOf(span_html_text);
        var pre_inner_html = docbody_clone.innerHTML.slice(0, node_index);
        var body_str_index = 0;
        for (var i in pre_inner_html) {
            if (pre_inner_html[i] == '>') {
                body_str_index = body_str.indexOf('>', body_str_index) + 1;
            }
        }

        $(id).remove();
        return body_str_index + offset;
    }

    function located_comment_mouseup_handler(e) {
        var index = getBodyIndex();
        var url = '/resource/comment/new?commented_item={{ item.pk }}&commented_item_version_number={{ itemversion.version_number }}&redirect={{ full_path|urlencode }}&commented_item_index=' + index;
        window.location = url;
    }

    function add_located_comment() {
        $('docbody').observe('mouseup', located_comment_mouseup_handler);
        $('add_located_comment_div').hide();
        $('adding_located_comment_div').show();
    }

    function cancel_add_located_comment() {
        $('docbody').stopObserving('mouseup', located_comment_mouseup_handler);
        $('add_located_comment_div').show();
        $('adding_located_comment_div').hide();
    }

    //ref_bless('docbody', '123');
    //gRegMgr.hl('123');
</script>

<!--<button onclick="gRegMgr.transmit();">Transmit Highlights</button>-->

<!-- Adapted from http://unraveled.com/projects/css_tabs/ -->
<style type="text/css">

/* begin css tabs */

ul#tabnav { /* general settings */
text-align: left; /* set to left, right or center */
margin: 1em 0 0 0; /* set margins as desired */
font: bold 11px verdana, arial, sans-serif; /* set font as desired */
border-bottom: 1px solid #6c6; /* set border COLOR as desired */
list-style-type: none;
padding: 3px 10px 3px 10px; /* THIRD number must change with respect to padding-top (X) below */
}

ul#tabnav li { /* do not change */
display: inline;
}

ul#tabnav li.tabhighlighted { /* settings for selected tab */
border-bottom: 1px solid #fff; /* set border color to page background color */
background-color: #fff; /* set background color to match above border color */
}

ul#tabnav li.tabhighlighted a { /* settings for selected tab link */
background-color: #fff; /* set selected tab background color as desired */
color: #000; /* set selected tab link color as desired */
position: relative;
top: 1px;
padding-top: 4px; /* must change with respect to padding (X) above and below */
}

ul#tabnav li a { /* settings for all tab links */
outline: none;
padding: 3px 4px; /* set padding (tab size) as desired; FIRST number must change with respect to padding-top (X) above */
border: 1px solid #6c6; /* set border COLOR as desired; usually matches border color specified in #tabnav */
background-color: #cfc; /* set unselected tab background color as desired */
color: #666; /* set unselected tab link color as desired */
margin-right: 0px; /* set additional spacing between tabs as desired */
text-decoration: none;
border-bottom: none;
}

ul#tabnav a:hover { /* settings for hover effect */
background: #fff; /* set desired hover color */
}

/* end css tabs */
	
div#section_body, div#section_comments, div#section_combined {
    border: 1px solid #6c6;
    border-top: none;
    padding: 10px;
}
</style>

<script type="text/javascript">
    function select_section_body() {
        $('section_body').appendChild($('section_body_inner'));
        $$('ul#tabnav li.tabhighlighted').each(function(e){e.removeClassName('tabhighlighted')});
        $('tab_body').addClassName('tabhighlighted');
        $('section_body').show();
        $('section_comments').hide();
        $('section_combined').hide();
    }
    function select_section_comments() {
        $('section_comments').appendChild($('section_comments_inner'));
        $$('ul#tabnav li.tabhighlighted').each(function(e){e.removeClassName('tabhighlighted')});
        $('tab_comments').addClassName('tabhighlighted');
        $('section_body').hide();
        $('section_comments').show();
        $('section_combined').hide();
    }
    function select_section_combined() {
        $('body_side').appendChild($('section_body_inner'));
        $('comments_side').appendChild($('section_comments_inner'));
        $$('ul#tabnav li.tabhighlighted').each(function(e){e.removeClassName('tabhighlighted')});
        $('tab_combined').addClassName('tabhighlighted');
        $('section_body').hide();
        $('section_comments').hide();
        $('section_combined').show();
    }
    /*
    var body_clone = $($('section_body_inner').cloneNode(true));
    var comments_clone = $($('section_comments_inner').cloneNode(true));
    $('body_side').appendChild(body_clone);
    $('comments_side').appendChild(comments_clone);
    */
</script>

<ul id="tabnav">
	<li id="tab_body" class="tabhighlighted"><a href="#" onclick="select_section_body(); return false;">Document</a></li>
	<li id="tab_combined"><a href="#" onclick="select_section_combined(); return false;">Side By Side</a></li>
	<li id="tab_comments"><a href="#" onclick="select_section_comments(); return false;">Comments ({{ item.comments_as_item.all|length }})</a></li>
</ul>

<div id="section_body">
<div id="section_body_inner">

<div id="refbase_123">
    <div><a href="#" onclick="$$('.commentref').each(function(e){e.toggle()}); return false;">Toggle Comments</a></div>
{% ifagentcan 'view' 'body' item %}
<div id="docbody" style="padding: 10px;">{% display_body_with_inline_comments itemversion %}</div>
{% else %}
<div id="docbody" style="padding: 10px;">
[PERMISSION DENIED]
</div>
{% endifagentcan %}
</div>

<div id="add_located_comment_div">
<a href="#" onclick="add_located_comment(); return false;">[+] Add Located Comment</a>
</div>

<div id="adding_located_comment_div" style="display: none;">
Now just select text where you want to comment or
<a href="#" onclick="cancel_add_located_comment(); return false;">Cancel</a>
</div>

</div>
</div>

<div id="section_combined" style="display: none;">
    <div id="body_side" style="float: left; width: 50%;"></div>
    <div id="comments_side" style="float: right; width: 50%;"></div>
    <div style="clear: both;"></div>
</div>

<div id="section_comments" style="display: none;">
<div id="section_comments_inner">
<div><a href="#" onclick="$$('.comment_body, .comment_description').each(function(e){e.toggle()}); return false;">Collapse/Expand</a></div>
{% commentbox %}
</div>
</div>

{% endblock content %}

