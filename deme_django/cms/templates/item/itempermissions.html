{% extends layout %}
{% load item_tags %}
{% block favicon %}{{ item|icon_url:16 }}{% endblock %}
{% block title %}<img src="{{ item|icon_url:48 }}" /> Permissions for {% viewable_name item %}{% endblock %}
{% block content %}

<script>
    var permission_counter = 1;
    var possible_abilities = [{% for ability in possible_abilities %}"{{ ability|escapejs }}",{% endfor %}];
    function add_permission_fields(wrapper, permission_type, agent_or_collection_id, is_allowed, ability) {
        var is_allowed_checkbox = $('<input type="checkbox" name="' + permission_counter + '_is_allowed" value="on">');
        is_allowed_checkbox.attr('checked', is_allowed);
        is_allowed_checkbox.attr('defaultChecked', is_allowed);
        var ability_select = $('<select name="' + permission_counter + '_ability">');
        for (var i in possible_abilities) {
            var is_selected = (possible_abilities[i] == ability);
            ability_select[0].options[i] = new Option(possible_abilities[i], possible_abilities[i], is_selected, is_selected);
        }
        var remove_button = $('<a href="#" class="img_link">');
        remove_button.addClass('img_link');
        remove_button.append('<img src="{{ "delete"|icon_url:16 }}" />');
        remove_button.bind('click', function(e){wrapper.remove(); return false;});
        wrapper.append(is_allowed_checkbox);
        wrapper.append(ability_select);
        wrapper.append(remove_button);
        wrapper.append('<input type="hidden" name="' + permission_counter + '_permission_type" value="' + permission_type + '" />');
        wrapper.append('<input type="hidden" name="' + permission_counter + '_agent_or_collection_id" value="' + agent_or_collection_id + '" />');
        permission_counter += 1;
    }

    function add_permission_div(wrapper, permission_type, agent_or_collection_id, is_allowed, ability) {
        var permission_div = $('<div>');
        add_permission_fields(permission_div, permission_type, agent_or_collection_id, is_allowed, ability);
        wrapper.append(permission_div);
    }

    function add_agent_or_collection_row(permission_type, agent_or_collection_id, name) {
        var row = $('<tr>');
        if (permission_type == 'agent') {
            var name_url = '{% url item_url viewer="agent",noun="1" %}'.replace('1', agent_or_collection_id);
            row.append('<td><a href="' + name_url + '">' + name + '</a></td>');
        } else if (permission_type == 'collection') {
            var name_url = '{% url item_url viewer="collection",noun="1" %}'.replace('1', agent_or_collection_id);
            row.append('<td><a href="' + name_url + '">' + name + '</a></td>');
        } else if (permission_type == 'everyone') {
            row.append('<td>' + name + '</td>');
        }
        var permissions_cell = $('<td>');
        permissions_cell.addClass('permissions_cell');
        var add_button = $('<a href="#" class="img_link">');
        add_button.append('<img src="{{ "new"|icon_url:16 }}" /> New Permission');
        add_button.bind('click', function(e){
            var permission_div = $('<div>');
            add_permission_fields(permission_div, permission_type, agent_or_collection_id, true, '');
            permissions_cell.append(permission_div);
            return false;
        });
        permissions_cell.append(add_button);
        row.append(permissions_cell);
        $('#permission_table tbody').append(row);
        return row;
    }

    $(document).ready(function(){
        {% for agent_datum in agent_data %}
            var agent_row = add_agent_or_collection_row("agent", "{{ agent_datum.agent.pk }}", '{% viewable_name agent_datum.agent %}'); //TODO escapejs
            var permissions_cell = agent_row.children('td.permissions_cell');
            {% for p in agent_datum.permissions|dictsort:"ability" %}
                add_permission_div(permissions_cell, "agent", "{{ agent_datum.agent.pk }}", {% if p.is_allowed %}true{% else %}false{% endif %}, "{{ p.ability|escapejs }}");
            {% endfor %}
            $('#permission_table tbody').append(agent_row);
        {% endfor %}

        {% for collection_datum in collection_data %}
            var collection_row = add_agent_or_collection_row("collection", "{{ collection_datum.collection.pk }}", '{% viewable_name collection_datum.collection %}'); //TODO escapejs
            var permissions_cell = collection_row.children('td.permissions_cell');
            {% for p in collection_datum.permissions|dictsort:"ability" %}
            add_permission_div(permissions_cell, "collection", "{{ collection_datum.collection.pk }}", {% if p.is_allowed %}true{% else %}false{% endif %}, "{{ p.ability|escapejs }}");
            {% endfor %}
            $('#permission_table tbody').append(collection_row);
        {% endfor %}

        var everyone_row = add_agent_or_collection_row("everyone", "0", 'Everyone');
        var permissions_cell = everyone_row.children('td.permissions_cell');
        {% for p in everyone_permissions|dictsort:"ability" %}
            add_permission_div(permissions_cell, "everyone", "0", {% if p.is_allowed %}true{% else %}false{% endif %}, "{{ p.ability|escapejs }}");
        {% endfor %}

        $('#new_agent_dialog').dialog({
            autoOpen: false,
            close: function(event, ui){
                $('input[name=\'new_agent\']').val('');
                $('input[name=\'new_agent_search\']').val('');
            },
            buttons: {
                'Add Agent': function(){
                    add_agent_or_collection_row('agent', $('input[name=\'new_agent\']').val(), $('input[name=\'new_agent_search\']').val());
                    $(this).dialog("close");
                },
                'Cancel': function(){
                    $(this).dialog("close");
                }
            },
        });

        $('#new_collection_dialog').dialog({
            autoOpen: false,
            close: function(event, ui){
                $('input[name=\'new_collection\']').val('');
                $('input[name=\'new_collection_search\']').val('');
            },
            buttons: {
                'Add Collection': function(){
                    add_agent_or_collection_row('collection', $('input[name=\'new_collection\']').val(), $('input[name=\'new_collection_search\']').val());
                    $(this).dialog("close");
                },
                'Cancel': function(){
                    $(this).dialog("close");
                }
            },
        });
    });
</script>

<div id="new_agent_dialog" style="display: none;">
    Name: {{ new_agent_select_widget|safe }}
</div>

<div id="new_collection_dialog" style="display: none;">
    Name: {{ new_collection_select_widget|safe }}
</div>

<form method="post" action="{% url item_url viewer=viewer_name,noun=item.pk,action="updateitempermissions" %}?redirect={{ full_path|urlencode }}" class="item_form">
<table id="permission_table" class="list" cellspacing="0">
    <tbody>
        <tr>
            <th>Name</th>
            <th>Permissions</th>
        </tr>
    </tbody>
</table>

<button type="button" onclick="$('#new_agent_dialog').dialog('open');"><img src="{{ "Agent"|icon_url:16 }}" /> <span>Select  Agent</span></button>
<button type="button" onclick="$('#new_collection_dialog').dialog('open');"><img src="{{ "Collection"|icon_url:16 }}" /> <span>Select  Collection</span></button>
<button type="submit"><img src="{{ "checkbox"|icon_url:16 }}" /> <span>Save Permissions</span></button>

</form>

<div>
    The following permissions are set by default as <a href="{% url item_type_url viewer="demesetting",action="modify" %}">Deme settings</a>. They may change at any time.
</div>
{% for p in default_permissions|dictsort:"ability" %}
<div>
    {% ifequal p.is_allowed None %}?{% else %}{% if p.is_allowed %}+{% else %}-{% endif %}{% endifequal %}{{ p.ability }}
</div>
{% endfor %}

{% endblock content %}

