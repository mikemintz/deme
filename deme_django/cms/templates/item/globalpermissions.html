{% extends layout %}
{% load item_tags %}
{% block favicon %}{{ accepted_item_type|icon_url:16 }}{% endblock %}
{% block title %}<img src="{{ accepted_item_type|icon_url:48 }}" /> Global Permissions{% endblock %}
{% block content %}

<script type="text/javascript" src="/static/javascripts/prototype.js"></script>

{% typeheader "Global Permissions" %}

<div style="margin-bottom: 5px;">
    <form method="get" class="item_form">
        {{ new_agent_select_widget|safe }}
        <button type="submit"><img src="{{ "checkbox"|icon_url:16 }}" /> <span>Add agent</span></button>
    </form>
</div>

<div style="margin-bottom: 5px;">
    <form method="get" class="item_form">
        {{ new_collection_select_widget|safe }}
        <button type="submit"><img src="{{ "checkbox"|icon_url:16 }}" /> <span>Add collection</span></button>
    </form>
</div>

<table cellspacing="0" class="list">
    <tr>
        <th>Type</th>
        <th>Name</th>
        <th>Permissions</th>
        <th>Add</th>
    </tr>
    {% for agent_datum in agent_data %}
    <tr class="{% cycle 'even' 'odd' as row_parity %}">
        <td>Agent</td>
        <td><a href="{{ agent_datum.agent.get_absolute_url }}">{% viewable_name agent_datum.agent %}</a></td>
        <td>
            {% for p in agent_datum.permissions|dictsort:"ability" %}
                <div>
                    {% if p.is_allowed %}+{% else %}-{% endif %}{{ p.ability }}
                    <form style="display: inline;" method="post" enctype="multipart/form-data" action="{% url item_type_url viewer="item",action="globalpermissions" %}?formtype=agentpermission&redirect={{ full_path|urlencode }}&formprefix={{ agent_datum.permission_form.prefix|urlencode }}" class="item_form">
                        <input type="hidden" name="permission_to_delete" value="{{ p.pk }}" />
                        <button type="submit"><img src="{{ "delete"|icon_url:16 }}" /> <span>Remove</span></button>
                    </form>
                </div>
            {% endfor %}
        </td>
        <td>
            <div><a href="#" onclick="$('permission_form_{{ agent_datum.agent.pk }}').toggle(); return false;">[+] Permission</a></div>
            <div id="permission_form_{{ agent_datum.agent.pk }}" style="{% if agent_datum.permission_form_invalid %}{% else %}display: none;{% endif %}">
                <form method="post" enctype="multipart/form-data" action="{% url item_type_url viewer="item",action="globalpermissions" %}?formtype=agentpermission&redirect={{ full_path|urlencode }}&formprefix={{ agent_datum.permission_form.prefix|urlencode }}" class="item_form">
                    <table cellspacing="0">
                        {{ agent_datum.permission_form.as_table }}
                    </table>
                    <button type="submit"><img src="{{ "checkbox"|icon_url:16 }}" /> <span>Add permission</span></button>
                </form>
            </div>
        </td>
    </tr>
    {% endfor %}
    {% for collection_datum in collection_data %}
    <tr class="{% cycle row_parity %}">
        <td>Collection</td>
        <td><a href="{{ collection_datum.collection.get_absolute_url }}">{% viewable_name collection_datum.collection %}</a></td>
        <td>
            {% for p in collection_datum.permissions|dictsort:"ability" %}
                <div>
                    {% if p.is_allowed %}+{% else %}-{% endif %}{{ p.ability }}
                    <form style="display: inline;" method="post" enctype="multipart/form-data" action="{% url item_type_url viewer="item",action="globalpermissions" %}?formtype=collectionpermission&redirect={{ full_path|urlencode }}&formprefix={{ collection_datum.permission_form.prefix|urlencode }}" class="item_form">
                        <input type="hidden" name="permission_to_delete" value="{{ p.pk }}" />
                        <button type="submit"><img src="{{ "delete"|icon_url:16 }}" /> <span>Remove</span></button>
                    </form>
                </div>
            {% endfor %}
        </td>
        <td>
            <div><a href="#" onclick="$('permission_form_{{ collection_datum.collection.pk }}').toggle(); return false;">[+] Permission</a></div>
            <div id="permission_form_{{ collection_datum.collection.pk }}" style="{% if collection_datum.permission_form_invalid %}{% else %}display: none;{% endif %}">
                <form method="post" enctype="multipart/form-data" action="{% url item_type_url viewer="item",action="globalpermissions" %}?formtype=collectionpermission&redirect={{ full_path|urlencode }}&formprefix={{ collection_datum.permission_form.prefix|urlencode }}" class="item_form">
                    <table cellspacing="0">
                        {{ collection_datum.permission_form.as_table }}
                    </table>
                    <button type="submit"><img src="{{ "checkbox"|icon_url:16 }}" /> <span>Add permission</span></button>
                </form>
            </div>
        </td>
    </tr>
    {% endfor %}
    <tr class="{% cycle row_parity %}">
        <td>Everyone</td>
        <td></td>
        <td>
            {% for p in everyone_data.permissions|dictsort:"ability" %}
                <div>
                    {% if p.is_allowed %}+{% else %}-{% endif %}{{ p.ability }}
                    <form style="display: inline;" method="post" enctype="multipart/form-data" action="{% url item_type_url viewer="item",action="globalpermissions" %}?formtype=everyonepermission&redirect={{ full_path|urlencode }}&formprefix={{ everyone_data.permission_form.prefix|urlencode }}" class="item_form">
                        <input type="hidden" name="permission_to_delete" value="{{ p.pk }}" />
                        <button type="submit"><img src="{{ "delete"|icon_url:16 }}" /> <span>Remove</span></button>
                    </form>
                </div>
            {% endfor %}
        </td>
        <td>
            <div><a href="#" onclick="$('permission_form_everyone').toggle(); return false;">[+] Permission</a></div>
            <div id="permission_form_everyone" style="{% if everyone_data.permission_form_invalid %}{% else %}display: none;{% endif %}">
                <form method="post" enctype="multipart/form-data" action="{% url item_type_url viewer="item",action="globalpermissions" %}?formtype=everyonepermission&redirect={{ full_path|urlencode }}&formprefix={{ everyone_data.permission_form.prefix|urlencode }}" class="item_form">
                    <table cellspacing="0">
                        {{ everyone_data.permission_form.as_table }}
                    </table>
                    <button type="submit"><img src="{{ "checkbox"|icon_url:16 }}" /> <span>Add permission</span></button>
                </form>
            </div>
        </td>
    </tr>
</table>

{% endblock content %}

